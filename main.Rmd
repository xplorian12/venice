---
title: "Marina del Rey Market Report"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  html_document:
    toc: false
    theme: readable
    df_print: paged
    number_sections: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo   = FALSE,
  warning= FALSE,
  message= FALSE
)

library(dplyr)
library(tidyr)
library(tidyverse)
library(lubridate)
library(readr)
library(leaflet)
library(leaflet.extras)
library(patchwork)
library(scales)
library(tools)
library(htmltools)
library(tidycensus)
```



```{r}
options(scipen = 999)

base_folder <- "C:/Users/stange/Desktop/DTR/code/mdr/mdr/medians"

read_safely <- function(path) {
  x <- try(read_csv(path, show_col_types = FALSE), silent = TRUE)
  if (inherits(x, "try-error") || !("Date" %in% names(x))) {
    x <- read_csv(path, skip = 3, show_col_types = FALSE)
  }
  x
}
clean_num <- function(v) as.numeric(gsub("[,$]", "", as.character(v)))

files <- list.files(base_folder, pattern = "\\.csv$", full.names = TRUE, recursive = TRUE)

all_list <- vector("list", length(files))
names(all_list) <- files

for (fp in files) {
  df <- read_safely(fp)
  if (!"Date" %in% names(df)) next
  df$Date <- my(df$Date)

  lower_path <- tolower(fp)
  segment <- dplyr::case_when(
    grepl("(^|/|\\\\)condo(\\b|/|\\\\)", lower_path) | grepl("_condo\\.csv$", lower_path) ~ "condo",
    grepl("(^|/|\\\\)sfr(\\b|/|\\\\)",   lower_path) | grepl("_sfr\\.csv$",   lower_path) ~ "sfr",
    grepl("(^|/|\\\\)lease(\\b|/|\\\\)", lower_path) | grepl("lease",          lower_path) ~ "lease",
    TRUE ~ "other"
  )

  fname  <- file_path_sans_ext(basename(fp)) |> tolower()
  metric <- fname
  metric <- gsub("_(condo|sfr|lease)$", "", metric)  # remove trailing segment
  metric <- gsub("^(condo|sfr|lease)_", "", metric)  # remove leading segment
  metric <- gsub("^domsfr$", "dom", metric)          # normalize quirky names
  metric <- gsub("^dom_condo$", "dom", metric)
  metric <- gsub("psf$", "per_sqft", metric)         # psf -> per_sqft
  # (sfr_per_sqft -> per_sqft after removing leading 'sfr_')
  # (sold_volume_sfr -> sold_volume after removing trailing '_sfr')

  value_cols <- setdiff(names(df), "Date")
  if (!length(value_cols)) next
  df[value_cols] <- lapply(df[value_cols], clean_num)

  df_long <- df %>%
    pivot_longer(all_of(value_cols), names_to = "Series", values_to = "Value") %>%
    mutate(Segment = segment, Metric = metric) %>%
    select(Segment, Metric, Series, Date, Value) %>%
    tidyr::drop_na(Date, Value)

  all_list[[fp]] <- df_long
}

all_medians <- bind_rows(all_list)



# === Read individual data === 
# Set paths (use your working dir or absolute paths)
suppressPackageStartupMessages({ library(readr); library(dplyr) })

# Bounding box for MDR/Venice/LAX
bbox <- list(lat_min = 33.90, lat_max = 34.05, lon_min = -118.55, lon_max = -118.35)
clip_bbox <- function(df, bb) {
  dplyr::filter(df,
    dplyr::between(latitude,  bb$lat_min, bb$lat_max),
    dplyr::between(longitude, bb$lon_min, bb$lon_max)
  )
}

# helpers
pick_col <- function(nms, candidates) { h <- intersect(candidates, nms); if (length(h)) h[1] else NA_character_ }

clean_points <- function(path, segment_label) {
  df <- read_csv(path, show_col_types = FALSE)
  names(df) <- tolower(gsub("\\s+", "_", names(df)))

  lat_col <- pick_col(names(df), c("latitude","lat","y"))
  lon_col <- pick_col(names(df), c("longitude","long","lng","lon","x"))
  sp_col  <- pick_col(names(df), c("sp","sale_price","sold_price","price"))
  dom_col <- pick_col(names(df), c("dom","days_on_market","daysmarket"))
  if (is.na(lat_col) || is.na(lon_col)) stop(sprintf("Missing lat/lon in %s", path))

  out <- tibble::tibble(
    latitude  = df[[lat_col]],
    longitude = df[[lon_col]],
    SP  = if (!is.na(sp_col))  as.numeric(gsub("[^0-9.]", "", as.character(df[[sp_col]]))) else NA_real_,
    DOM = if (!is.na(dom_col)) as.numeric(gsub("[^0-9.]", "", as.character(df[[dom_col]]))) else NA_real_
  ) |>
    clip_bbox(bbox) |>
    dplyr::mutate(
      price_range = cut(
        SP,
        breaks = c(0, 700000, 1000000, 1500000, Inf),
        labels = c("Under $700K", "$700K–$1M", "$1M–$1.5M", "Over $1.5M"),
        include.lowest = TRUE
      ),
      Segment = segment_label
    )

  out
}

# Read files
sales_condo <- clean_points("lat_only_condo.csv", "Condo")
sales_sfr   <- clean_points("lat_only_sfr.csv",   "SFR")

# Combined, bbox-limited
sales_data  <- dplyr::bind_rows(sales_condo, sales_sfr) # combined (may be just condo until SFR arrives)

```


<h3><strong>Purpose: Get a strong understanding of the market (with a focus on condos) and find opportunities.</h3>


```{r}
# === Flagship time series visual graph ===
combined_df <- all_medians %>%
  dplyr::filter(
    Metric == "median_sale",
    Series == "Marina del Rey",
    Segment %in% c("sfr", "condo")
  ) %>%
  dplyr::mutate(
    Type  = dplyr::if_else(Segment == "sfr", "SFR", "Condo"),
    Price = as.numeric(Value)
  ) %>%
  dplyr::select(Date, Price, Type) %>%
  dplyr::arrange(Type, Date)

# --- Plot 1: price levels ---
p_level <- ggplot2::ggplot(combined_df, ggplot2::aes(Date, Price, color = Type)) +
  ggplot2::geom_line() +
  ggplot2::geom_smooth(
    ggplot2::aes(color = Type, group = Type),  # one curve per Type, matching color
    method = "loess", se = FALSE,
    linetype = "solid", linewidth = 1.3
  ) +
  ggplot2::scale_y_continuous(
    labels = scales::comma,
    breaks = scales::pretty_breaks(10),
    limits = c(0, 3000000)                    # cap at $3,000,000
  ) +
  ggplot2::labs(
    title = "Median Sale Price — SFR vs Condo (Marina del Rey)",
    x = NULL, y = "Sale Price (USD)"
  ) +
  ggplot2::guides(color = ggplot2::guide_legend(title = NULL))

# --- Compute MoM % change ---
pct_df <- combined_df %>%
  dplyr::group_by(Type) %>%
  dplyr::arrange(Date, .by_group = TRUE) %>%
  dplyr::mutate(PctChange = Price / dplyr::lag(Price, 1) - 1) %>%
  dplyr::ungroup()

# --- Plot 2: MoM % change ---
p_pct <- ggplot2::ggplot(pct_df, ggplot2::aes(Date, PctChange, color = Type)) +
  ggplot2::geom_hline(yintercept = 0, linetype = "dotted") +
  ggplot2::geom_line(na.rm = TRUE) +
  ggplot2::geom_smooth(
    ggplot2::aes(color = Type, group = Type),
    method = "loess", se = FALSE,
    linetype = "solid", linewidth = 1.3
  ) +
  ggplot2::scale_y_continuous(
    labels = scales::percent_format(accuracy = 0.1),
    breaks  = seq(-0.6, 0.6, by = 0.05),  # 5% increments
    limits  = c(NA, 0.6)                   # cap top at 60%, keep negatives visible
  ) +
  ggplot2::labs(
    title = "Median Sale Price — MoM % Change (SFR vs Condo)",
    x = NULL, y = "Change"
  ) +
  ggplot2::guides(color = ggplot2::guide_legend(title = NULL))

# --- Render as two separate graphs ---
p_level
p_pct

```



General outlook: As can be observed from the graphs, ever since 2023, the MDR markets for condos and SFRs have been slowing down. However, since the beginning of 2025, both condos and SFR sales have been slowly picking up. Overall, the last 5 years saw a stagnation in MDR.





```{r condo_price_by_bedroom, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}
# Median Condo Sale Price by Bedroom (Studio, 1–4BR, 5BR+)

suppressWarnings({
  # --- locate file ---
  candidates <- c(
    "lat_only_condo.csv",
    file.path("medians", "lat_only_condo.csv"),
    "C:/Users/stange/Desktop/DTR/code/mdr/mdr/medians/lat_only_condo.csv"
  )
  condo_path <- candidates[file.exists(candidates)][1]
  if (is.na(condo_path)) stop("lat_only_condo.csv not found. Update path in this chunk.")

  # --- read & normalize names ---
  df <- readr::read_csv(condo_path, show_col_types = FALSE)
  names(df) <- tolower(gsub("\\s+", "_", names(df)))

  # --- sale price (SP) ---
  sp_col <- intersect(c("sp","sale_price","sold_price","price","close_price"), names(df))[1]
  if (is.na(sp_col)) stop("No sale price column found (expected SP/sale_price/etc.).")
  df$SP <- as.numeric(gsub("[^0-9.]", "", as.character(df[[sp_col]])))

  # --- bedrooms ---
  bed_col <- intersect(c("br","beds","bedrooms","bedroom","bedroomstotal"), names(df))[1]
  if (is.na(bed_col)) stop("No bedroom column found (expected BR/beds/bedrooms/etc.).")
  raw_bed <- df[[bed_col]]
  if (!is.numeric(raw_bed)) {
    raw_str <- tolower(as.character(raw_bed))
    raw_num <- suppressWarnings(as.numeric(stringr::str_extract(raw_str, "\\d+")))
    raw_num[is.na(raw_num) & grepl("studio|^st\\b", raw_str)] <- 0
    raw_bed <- raw_num
  }
  df$Beds <- raw_bed

  # --- clean & bucket ---
  condo_clean <- df %>%
    dplyr::filter(!is.na(SP), dplyr::between(SP, 50000, 20000000), !is.na(Beds)) %>%
    dplyr::mutate(
      BedLabel = dplyr::case_when(
        Beds <= 0 ~ "Studio",
        Beds == 1 ~ "1BR",
        Beds == 2 ~ "2BR",
        Beds == 3 ~ "3BR",
        Beds == 4 ~ "4BR",
        Beds >= 5 ~ "5BR+"
      ),
      BedLabel = factor(BedLabel, levels = c("Studio","1BR","2BR","3BR","4BR","5BR+"))
    )

  agg <- condo_clean %>%
    dplyr::group_by(BedLabel) %>%
    dplyr::summarise(
      MedianPrice = median(SP, na.rm = TRUE),
      n = dplyr::n(),
      .groups = "drop"
    )

  # --- plot ---
  p_condo_bed_price <- ggplot2::ggplot(agg, ggplot2::aes(BedLabel, MedianPrice)) +
    ggplot2::geom_col() +
    ggplot2::scale_y_continuous(labels = scales::dollar_format(),
                                breaks = scales::pretty_breaks(8),
                                expand = ggplot2::expansion(mult = c(0, .06))) +
    ggplot2::labs(
      title = "Median Condo Sale Price by Bedroom Count",
      x = NULL, y = "Median Price (USD)"
    )

  print(p_condo_bed_price)
})

```


The median price for SFR in MDR is around $1,700,000, while condos are closer to $1,400,000. From the above bar chart we can see that there is a significant jump in prices between 1 bedroom condos and 2 bedroom condos, almost double.



<h2>Market Overview - Pricing & Analysis</h2>


```{r}
SeriesName <- "Marina del Rey"
label_type <- function(seg) ifelse(tolower(seg) == "sfr", "SFR", "Condo")

# -- 2.1 Median Sale Price (SFR vs Condo) --
price_df <- all_medians %>%
  filter(Metric == "median_sale", Series == SeriesName, Segment %in% c("sfr","condo")) %>%
  mutate(Type = label_type(Segment))

p_price <- ggplot(price_df, aes(Date, Value, color = Type)) +
  geom_line() +
  geom_smooth(method = "loess", se = FALSE, linetype = "dashed") +
  scale_y_continuous(labels = comma, breaks = pretty_breaks(n = 10)) +
  labs(title = "Median Sale Price — SFR vs Condo", x = NULL, y = "Sale Price (USD)")

# -- 2.2 $/SqFt (SFR vs Condo) --
psf_df <- all_medians %>%
  filter(Metric == "per_sqft", Series == SeriesName, Segment %in% c("sfr","condo")) %>%
  mutate(Type = label_type(Segment))

p_psf <- ggplot(psf_df, aes(Date, Value, color = Type)) +
  geom_line() +
  geom_smooth(method = "loess", se = FALSE, linetype = "dashed") +
  scale_y_continuous(labels = comma, breaks = pretty_breaks(n = 10)) +
  labs(title = "$ per SqFt — SFR vs Condo", x = NULL, y = "$/SqFt")

# -- 2.3 Volume of Closed Sales (monthly) --
vol_dollars <- all_medians %>%
  filter(Metric == "sold_volume", Series == SeriesName, Segment %in% c("sfr","condo")) %>%
  mutate(Type = label_type(Segment))

if (nrow(vol_dollars) > 0) {
  vol_condo <- dplyr::filter(vol_dollars, Type == "Condo")
  p_volume_dollars <- ggplot(vol_condo, aes(Date, Value)) +
    geom_col(fill = "#0d6efd") +
    scale_y_continuous(labels = scales::comma, breaks = scales::pretty_breaks(8)) +
    labs(title = "Closed Sales Volume ($) — Condos (Monthly)", x = NULL, y = "Sold Volume (USD)")
} else {
  p_volume_dollars <- NULL
}

vol_counts <- all_medians %>%
  filter(Metric %in% c("closed","closed_sales","closed_count"),
         Series == SeriesName, Segment %in% c("sfr","condo")) %>%
  mutate(Type = label_type(Segment))

if (nrow(vol_counts) > 0) {
  p_volume_counts <- ggplot(vol_counts, aes(Date, Value, fill = Type)) +
    geom_col(position = "dodge") +
    scale_y_continuous(labels = comma, breaks = pretty_breaks(n = 8)) +
    labs(title = "Closed Sales (Count) — Monthly", x = NULL, y = "Closed Sales (count)")
} else {
  p_volume_counts <- NULL
}

# -- 2.4 New-to-Closed Deal Ratio --
new_df <- all_medians %>%
  filter(Metric %in% c("new_listing","new_listings"),
         Series == SeriesName, Segment %in% c("sfr","condo")) %>%
  transmute(Segment, Date, New = Value)

closed_df <- all_medians %>%
  filter(Metric %in% c("closed","closed_sales","closed_count"),
         Series == SeriesName, Segment %in% c("sfr","condo")) %>%
  transmute(Segment, Date, Closed = Value)

ratio_df <- full_join(new_df, closed_df, by = c("Segment","Date")) %>%
  mutate(Ratio = if_else(!is.na(Closed) & Closed > 0, New / Closed, NA_real_),
         Type  = label_type(Segment))

p_ratio <- ggplot(ratio_df, aes(Date, Ratio, color = Type)) +
  geom_line(na.rm = TRUE) +
  geom_smooth(method = "loess", se = FALSE, linetype = "dashed", na.rm = TRUE) +
  scale_y_continuous(labels = number_format(accuracy = 0.01), breaks = pretty_breaks(n = 8)) +
  labs(title = "New-to-Closed Deal Ratio — Supply vs Demand", x = NULL, y = "New / Closed")

# -- 2.5 Days on Market (DOM) —
dom_df <- all_medians %>%
  mutate(Metric = ifelse(Metric %in% c("domsfr","dom_condo"), "dom", Metric)) %>%
  filter(Metric == "dom", Series == SeriesName, Segment %in% c("sfr","condo")) %>%
  mutate(Type = label_type(Segment))

p_dom <- ggplot(dom_df, aes(Date, Value, color = Type)) +
  geom_line() +
  geom_smooth(method = "loess", se = FALSE, linetype = "dashed") +
  scale_y_continuous(breaks = pretty_breaks(n = 8)) +
  labs(title = "Days on Market — SFR vs Condo", x = NULL, y = "Days")

# --- PRINTS AT THE END ---
print(p_psf)

print(p_ratio)
print(p_dom)

```

Above we can see the $/sqft graph, again illustrating the 5 year stagnation. as of August 2025, condos in MDR have a median price-per-sqft of $800, while SFRs go for a median of $1,050/sqft.


```{r}
if (!is.null(p_volume_dollars)) print(p_volume_dollars)
if (!is.null(p_volume_counts)) print(p_volume_counts)
```

From the above two charts we can see that the entire market has been slowing down in the last 3 years, both in volume and count.


```{r}
print(p_ratio)
print(p_dom)
```
Demand
New/Closed ratio is helpful for understanding power in the market. The higher the ratio, the more power buyers have. In this case, the ratio is increasing every year, signifying an increasing buyer's market. 

Likewise, the increasing days-on-market also serves as additional evidence that buyers are more reluctant to buy, signifying strong buyer power.


```{r maps}
#=== clean sales data ===
suppressPackageStartupMessages({
  library(dplyr); library(leaflet); library(leaflet.extras); library(scales); library(htmltools)
})

# Fan overlapping points
fan_points <- function(df, offset = 0.0003) {
  if (nrow(df) == 0) return(df)
  df %>%
    group_by(latitude, longitude) %>%
    mutate(
      index = dplyr::row_number(),
      total = dplyr::n(),
      angle = 2 * pi * (index - 1) / pmax(total, 1),
      jitter_lat = latitude  + offset * sin(angle),
      jitter_lon = longitude + offset * cos(angle)
    ) %>% ungroup()
}

# Compact HTML size legend (pin size ≈ number of sales)
make_size_legend <- function(counts = c(1, 5, 15), title = "Pin size = # of sales") {
  r <- pmin(14, log(counts + 1) * 5)
  items <- paste0(
    '<div style="display:flex;align-items:center;margin:4px 0">',
    '<div style="width:', 2*r, 'px;height:', 2*r, 'px;border-radius:50%;border:1px solid #000;margin-right:8px;"></div>',
    '<span>', counts, '</span>',
    '</div>',
    collapse = ""
  )
  paste0(
    '<div style="background:white;padding:8px 10px;border:1px solid #999;border-radius:6px;',
    'box-shadow:0 1px 4px rgba(0,0,0,.2);font-size:12px;max-width:180px;max-height:160px;overflow:auto">',
    '<div style="font-weight:600;margin-bottom:4px;">', title, '</div>',
    items,
    '</div>'
  )
}

size_legend_pos <- "topright"  # moved from bottomleft → topright

# ---------------------------------------------------------------
# 1) Condo-only price pins (legend by price_range + size legend)
# ---------------------------------------------------------------
condo_bins <- sales_condo %>%
  filter(!is.na(SP)) %>%
  mutate(price_range = cut(
    SP,
    breaks = c(0, 700000, 1000000, 1500000, Inf),
    labels = c("Under $700K", "$700K–$1M", "$1M–$1.5M", "Over $1.5M"),
    include.lowest = TRUE
  )) %>%
  filter(!is.na(price_range)) %>%
  group_by(latitude, longitude, price_range) %>%
  summarise(count = n(), avg_price = mean(SP, na.rm = TRUE), .groups = "drop") %>%
  fan_points()

pal_price <- colorFactor(
  palette = c("blue", "green", "orange", "red"),
  domain  = c("Under $700K", "$700K–$1M", "$1M–$1.5M", "Over $1.5M"),
  na.color = "transparent"
)

condo_price_pin_map <- leaflet(condo_bins, width = "100%", height = 620) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addCircleMarkers(
    lng = ~jitter_lon, lat = ~jitter_lat,
    radius = ~pmin(14, log(count + 1) * 5),
    color = "black",
    fillColor = ~pal_price(price_range),
    fillOpacity = 0.85, weight = 1,
    label = ~paste0(count, " sale(s) in ", price_range),
    popup = ~paste0(
      "<b>Sales in this range:</b> ", count, "<br>",
      "<b>Price Range:</b> ", price_range, "<br>",
      "<b>Avg Price:</b> $", format(round(avg_price), big.mark = ",")
    )
  ) %>%
  addLegend("bottomright", pal = pal_price, values = ~price_range, title = "Price Range") %>%
  addControl(html = HTML(make_size_legend(c(1, 5, 15))), position = size_legend_pos)

# ---------------------------------------------------------------
# 2) DOM heatmap — sharper + numeric legend
# ---------------------------------------------------------------
if (any(!is.na(sales_data$DOM))) {
  dom_heat_data <- sales_data %>% filter(!is.na(DOM) & is.finite(DOM))
  rng <- range(dom_heat_data$DOM, na.rm = TRUE)

  # inverse DOM (lower DOM -> hotter)
  dom_heat_data <- dom_heat_data %>%
    mutate(dom_intensity = if (diff(rng) > 0) {
      (max(DOM, na.rm = TRUE) - DOM) / diff(rng)
    } else 0.5)

  dom_heat_map <- leaflet(dom_heat_data, width = "100%", height = 620) %>%
    addProviderTiles(providers$CartoDB.Positron) %>%
    addHeatmap(
      lng = ~longitude, lat = ~latitude, intensity = ~dom_intensity,
      blur = 24, radius = 20, max = 1, minOpacity = 0.5,
      gradient = c("0.00"="blue","0.50"="orange","1.00"="red")
    )

  # Legend: DOM quantiles (fast → slow)
  qs <- quantile(dom_heat_data$DOM, probs = c(0.25, 0.50, 0.75), na.rm = TRUE)
  leg_cols <- c("red","orange","blue")
  leg_labs <- c(
    paste0("Fast (≤ ", round(qs[1]), " days)"),
    paste0("Moderate (", round(qs[1] + 1), "–", round(qs[3]), " days)"),
    paste0("Slow (≥ ", round(qs[3]), " days)")
  )
  dom_heat_map <- dom_heat_map %>%
    addLegend("bottomright", colors = leg_cols, labels = leg_labs,
              title = "DOM (lower = hotter)", opacity = 0.9)
} else {
  # Price proxy fallback
  dom_heat_data <- sales_data %>% filter(!is.na(SP))
  rng <- range(dom_heat_data$SP, na.rm = TRUE)
  dom_heat_data <- dom_heat_data %>%
    mutate(dom_intensity = if (diff(rng) > 0) {
      (SP - min(SP, na.rm = TRUE)) / diff(rng)
    } else 0.5)

  dom_heat_map <- leaflet(dom_heat_data, width = "100%", height = 620) %>%
    addProviderTiles(providers$CartoDB.Positron) %>%
    addHeatmap(
      lng = ~longitude, lat = ~latitude, intensity = ~dom_intensity,
      blur = 24, radius = 20, max = 1, minOpacity = 0.5,
      gradient = c("0.00"="blue","0.50"="orange","1.00"="red")
    )

  qs <- quantile(dom_heat_data$SP, probs = c(0.25, 0.50, 0.75), na.rm = TRUE)
  dom_heat_map <- dom_heat_map %>%
    addLegend("bottomright",
              colors = c("red","orange","blue"),
              labels = c(
                paste0("Higher Price (≥ $", scales::comma(round(qs[3])), ")"),
                paste0("Mid ($", scales::comma(round(qs[1] + 1)), "–$", scales::comma(round(qs[3])), ")"),
                paste0("Lower Price (≤ $", scales::comma(round(qs[1])), ")")
              ),
              title = "Proxy (Price)", opacity = 0.9)
}

# ---------------------------------------------------------------
# 3) SFR vs Condo pins (legend by Segment + size legend)
# ---------------------------------------------------------------
seg_bins <- sales_data %>%
  filter(!is.na(latitude), !is.na(longitude)) %>%
  group_by(latitude, longitude, Segment) %>%
  summarise(count = n(), avg_price = mean(SP, na.rm = TRUE), .groups = "drop") %>%
  fan_points()

pal_seg <- colorFactor(
  palette = c("Condo" = "#1f77b4", "SFR" = "#d62728"),
  domain  = c("Condo","SFR"),
  na.color = "transparent"
)

seg_pin_map <- leaflet(seg_bins, width = "100%", height = 620) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addCircleMarkers(
    lng = ~jitter_lon, lat = ~jitter_lat,
    radius = ~pmin(14, log(count + 1) * 5),
    color = "black",
    fillColor = ~pal_seg(Segment),
    fillOpacity = 0.85, weight = 1,
    label = ~paste0(Segment, ": ", count, " sale(s)"),
    popup = ~paste0(
      "<b>Segment:</b> ", Segment, "<br>",
      "<b>Sales at this location:</b> ", count, "<br>",
      "<b>Avg Price:</b> $", format(round(avg_price), big.mark = ",")
    )
  ) %>%
  addLegend("bottomright", pal = pal_seg, values = ~Segment, title = "Segment") %>%
  addControl(html = HTML(make_size_legend(c(1, 5, 15))), position = size_legend_pos)

# Print in order
condo_price_pin_map

```

<div class="note">Overlapping addresses are “fanned” with a tiny offset so your broker can see density clusters at a glance.</div>
<div class="page-break"></div>


Sale locations

The above map shows condo sale in the last 2 year by price point and location. Many of the larger locations come from 5 specific buildings.

```{r}
dom_heat_map
seg_pin_map
```

The above two maps show that MDR is really split between the marina surrounding condo sales, and the inland SFR dominated market. 

The heatmap shows hot locations.


```{r lease_section, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}
#Rental Market Analysis

# ---- Paths ----
med_dir  <- "C:/Users/stange/Desktop/DTR/code/mdr/mdr/medians"
lease_ts_path    <- file.path(med_dir, "lease", "lease.csv")
condo_lease_path <- file.path(med_dir, "lease", "condo_lease.csv")
sfr_lease_path   <- file.path(med_dir, "lease", "sfr_lease.csv")
condo_price_path <- file.path(med_dir, "condo", "median_sale_condo.csv")
sfr_price_path   <- file.path(med_dir, "sfr",   "median_sale_sfr.csv")

# ---- Minimal helpers ----
parse_date <- function(x){
  d <- suppressWarnings(lubridate::my(x))
  i <- is.na(d); if (any(i)) d[i] <- suppressWarnings(lubridate::ymd(x[i]))
  i <- is.na(d); if (any(i)) d[i] <- suppressWarnings(lubridate::mdy(x[i]))
  as.Date(d)
}

read_median <- function(path){
  if (!file.exists(path)) return(tibble(Date=as.Date(character()), Value=double()))
  df <- suppressWarnings(tryCatch(readr::read_csv(path, show_col_types=FALSE), error=function(e) NULL))
  if (!is.null(df) && any(tolower(names(df))=="date")) {
    d <- names(df)[tolower(names(df))=="date"][1]
    v <- setdiff(names(df), d)[1]
    out <- tibble(Date=parse_date(df[[d]]),
                  Value=as.numeric(gsub("[^0-9.]", "", as.character(df[[v]]))))
  } else {
    df2 <- tryCatch(read.csv(path, stringsAsFactors=FALSE, skip=3), error=function(e) NULL)
    if (is.null(df2) || ncol(df2)<2) return(tibble(Date=as.Date(character()), Value=double()))
    out <- tibble(Date=parse_date(df2[[1]]),
                  Value=as.numeric(gsub("[^0-9.]", "", as.character(df2[[2]]))))
  }
  dplyr::filter(out, !is.na(Date), !is.na(Value))
}

# ---- 1) Median lease price over time ----
lease_ts <- read_median(lease_ts_path) %>%
  dplyr::filter(dplyr::between(Value, 300, 30000)) %>%
  dplyr::arrange(Date)

p_lease_trend <- if (nrow(lease_ts)) {
  ggplot(lease_ts, aes(Date, Value)) +
    geom_line() +
    geom_smooth(method="loess", se=FALSE, linetype="dashed") +
    scale_y_continuous(labels=scales::dollar_format(), breaks=scales::pretty_breaks(8)) +
    labs(title="Median Lease Price — Trend (Marina del Rey)", x=NULL, y="Monthly Rent (USD)")
} else NULL

# ---- 2) Bedroom bars ----
make_bed_bars <- function(path, title_prefix){
  if (!file.exists(path)) return(NULL)
  df <- readr::read_csv(path, show_col_types=FALSE)
  stopifnot(all(c("SP","BR") %in% names(df)))
  agg <- df %>%
    dplyr::mutate(
      Rent = as.numeric(gsub("[^0-9.]", "", as.character(SP))),
      Beds = suppressWarnings(as.numeric(BR)),
      Bed  = dplyr::case_when(
        is.na(Beds) ~ NA_character_,
        Beds <= 0   ~ "Studio",
        Beds == 1   ~ "1BR",
        Beds == 2   ~ "2BR",
        Beds == 3   ~ "3BR",
        Beds == 4   ~ "4BR",
        Beds >= 5   ~ "5BR"
      )
    ) %>%
    dplyr::filter(!is.na(Bed), !is.na(Rent), dplyr::between(Rent, 300, 30000)) %>%
    dplyr::group_by(Bed) %>%
    dplyr::summarise(MedianRent = median(Rent, na.rm=TRUE), .groups="drop") %>%
    dplyr::mutate(Bed = factor(Bed, levels=c("Studio","1BR","2BR","3BR","4BR","5BR"))) %>%
    dplyr::arrange(Bed)

  if (!nrow(agg)) return(NULL)
  ggplot(agg, aes(Bed, MedianRent)) +
    geom_col() +
    scale_y_continuous(labels=scales::dollar_format(), breaks=scales::pretty_breaks(8)) +
    labs(title=paste0(title_prefix, " — Median Lease by Bedroom (All Leases)"),
         x=NULL, y="Monthly Rent (USD)")
}

p_condo_beds <- make_bed_bars(condo_lease_path, "Condo")
p_sfr_beds   <- make_bed_bars(sfr_lease_path,   "SFR")

# ---- 3) Price-to-Rent ratio ----
condo_price <- read_median(condo_price_path) %>% dplyr::mutate(Segment="Condo")
sfr_price   <- read_median(sfr_price_path)   %>% dplyr::mutate(Segment="SFR")
price_ts    <- dplyr::bind_rows(condo_price, sfr_price) %>%
  dplyr::rename(Price=Value) %>%
  dplyr::filter(!is.na(Price)) %>%
  dplyr::arrange(Date)

ratio_df <- price_ts %>%
  dplyr::inner_join(lease_ts %>% dplyr::rename(Rent=Value), by="Date") %>%
  dplyr::filter(Rent>0, Price>0) %>%
  dplyr::mutate(Type=paste0(Segment," ÷ Lease"), Ratio=Price / Rent)

p_ratio <- if (nrow(ratio_df)) {
  ggplot(ratio_df, aes(Date, Ratio, color=Type)) +
    geom_line() +
    geom_smooth(method="loess", se=FALSE, linetype="dashed") +
    scale_y_continuous(breaks=scales::pretty_breaks(8)) +
    labs(title="Price-to-Rent Ratio — Median Sale / Median Lease",
         x=NULL, y="Price / Rent Ratio") +
    guides(color=guide_legend(title=NULL))
} else NULL

# ---- 4) Rental Vacancy Rate ----
census_api_key("9d5931816199a62a9bbf24d1fb859fe15fd9ba6c", install = FALSE)

years <- 2019:2023

fetch_vr <- function(y) {
  get_acs(
    geography = "place",
    state = "CA",
    survey = "acs5",
    year = y,
    variables = c(vac_for_rent = "B25004_003", renter_occ = "B25003_003")
  ) |>
    filter(NAME == "Marina del Rey CDP, California") |>
    select(variable, estimate, moe) |>
    pivot_wider(names_from = variable, values_from = c(estimate, moe)) |>
    transmute(
      Year = y,
      num = estimate_vac_for_rent,
      num_moe = moe_vac_for_rent,
      den = estimate_renter_occ + estimate_vac_for_rent,
      den_moe = moe_sum(moe_renter_occ, moe_vac_for_rent),
      vacancy = ifelse(den > 0, num / den, NA_real_),
      vacancy_moe = ifelse(den > 0, moe_prop(num, den, num_moe, den_moe), NA_real_)
    )
}

vac_5yr <- bind_rows(lapply(years, fetch_vr)) |>
  arrange(Year)

p_vac <- ggplot(vac_5yr, aes(x = Year, y = vacancy)) +
  geom_line() +
  geom_point(size = 2) +
  scale_x_continuous(breaks = years) +
  scale_y_continuous(labels = percent_format(accuracy = 0.1)) +
  labs(
    title = "Rental Vacancy Rate — Marina del Rey (ACS 5-year)",
    subtitle = "Computed as Vacant-for-Rent / (Renter-Occupied + Vacant-for-Rent)",
    x = NULL, y = "Vacancy Rate"
  )

# ---- Print all at end ----
if (inherits(p_lease_trend, "ggplot")) print(p_lease_trend)




```

Rental Market

Median lease prices in MDR have also been stagnating a bit. While they continuously rise, they do so at a declining rate, almost flattening at around $5,600 in July 2025.


```{r}
if (inherits(p_condo_beds,  "ggplot")) print(p_condo_beds)
if (inherits(p_sfr_beds,    "ggplot")) print(p_sfr_beds)

```

The above 2 charts show the median lease price for various unit sizes, for condos and SFRs. The jump in prices at the highest bedroom count can be partly attributed to the low quantity of such units, rather than size.



```{r}
if (inherits(p_ratio,       "ggplot")) print(p_ratio)
if (inherits(p_vac,         "ggplot")) print(p_vac)
```

The above two graphs are ratio signals of the rental market from an owner's perspective. The higher a price/rent ratio is, the higher the price of a property relative to lease price. While the price/rent ratio of SFRs in MDR are rising, meaning prices are increasing faster than rents, the ratio for condos is rather flat.


Vacancy rate, signaling how easy it is to find tenants, has been rising until 2021, and started slowly decreasing, meaning tenants are becoming more interested in moving to MDR. 



```{r mdr_acs_summary_updated, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}
# Assumes tidycensus + your Census key are already loaded/set,
# and ggplot2/patchwork are available from your setup.

yr <- 2023
place_name <- "Marina del Rey CDP, California"

# ---------- 1) Tenure (Owner vs Renter) ----------
tenure_wide <- tidycensus::get_acs(
  geography = "place", state = "CA", survey = "acs5", year = yr,
  variables = c(total="B25003_001", owner="B25003_002", renter="B25003_003")
) |>
  dplyr::filter(NAME == place_name) |>
  dplyr::select(variable, estimate) |>
  tidyr::pivot_wider(names_from = variable, values_from = estimate)

tenure <- tenure_wide |>
  dplyr::select(total, owner, renter) |>
  tidyr::pivot_longer(c(owner, renter), names_to = "Type", values_to = "Count") |>
  dplyr::mutate(
    Type = dplyr::recode(Type, owner = "Owner-occupied", renter = "Renter-occupied"),
    Rate = Count / total
  ) |>
  dplyr::select(Type, Rate)

p_tenure <- ggplot2::ggplot(tenure, ggplot2::aes(Type, Rate, fill = Type)) +
  ggplot2::geom_col() +
  ggplot2::scale_y_continuous(labels = scales::percent_format(accuracy = 0.1), limits = c(0,1)) +
  ggplot2::labs(title = "Tenure — Owner vs Renter (ACS 5-year, 2023)", x = NULL, y = "Share of Occupied Units") +
  ggplot2::guides(fill = "none")

# ---------- 2) Age distribution — 6 cohorts; side-by-side now vs past ----------
age_vars <- paste0("B01001_", sprintf("%03d", c(3:25, 27:49)))  # detailed male/female bins

cohortize <- function(df) {
  code_num <- as.integer(sub("B01001_", "", df$variable))
  df |>
    dplyr::mutate(
      Cohort = dplyr::case_when(
        # <18
        code_num %in% c(3:6, 27:30)          ~ "<18",
        # 18–24  (ACS bins: 18–19, 20, 21, 22–24)
        code_num %in% c(7:10, 31:34)         ~ "18–24",
        # 25–34  (25–29, 30–34)
        code_num %in% c(11:12, 35:36)        ~ "25–34",
        # 35–44
        code_num %in% c(13:14, 37:38)        ~ "35–44",
        # 45–54
        code_num %in% c(15:16, 39:40)        ~ "45–54",
        # 55–64
        code_num %in% c(17:19, 41:43)        ~ "55–64",
        # 65+
        code_num %in% c(20:25, 44:49)        ~ "65+",
        TRUE                                  ~ NA_character_
      )
    ) |>
    dplyr::filter(!is.na(Cohort)) |>
    dplyr::group_by(Cohort) |>
    dplyr::summarise(People = sum(estimate, na.rm = TRUE), .groups = "drop") |>
    dplyr::mutate(
      Share = People / sum(People),
      Cohort = factor(Cohort, levels = c("<18","18–24","25–34","35–44","45–54","55–64","65+"))
    )
}

pull_age <- function(y) {
  out <- try(
    tidycensus::get_acs(geography="place", state="CA", survey="acs5", year=y, variables=age_vars) |>
      dplyr::filter(NAME == place_name),
    silent = TRUE
  )
  if (inherits(out, "try-error") || is.null(out) || !nrow(out)) return(NULL)
  cohortize(out) |> dplyr::mutate(Year = y)
}

age_now  <- pull_age(yr)
age_past <- pull_age(yr - 10)
if (is.null(age_past)) age_past <- pull_age(yr - 5)

# If past not available, fall back to single chart
if (!is.null(age_now) && !is.null(age_past)) {
  p_age_now <- ggplot2::ggplot(age_now, ggplot2::aes(Cohort, Share, fill = Cohort)) +
    ggplot2::geom_col() +
    ggplot2::scale_y_continuous(labels = scales::percent_format(accuracy = 0.1), limits = c(0,1)) +
    ggplot2::labs(
      title = paste0("Age Distribution — ", unique(age_now$Year)),
      x = NULL, y = "Share of Population"
    ) + ggplot2::guides(fill = "none")

  p_age_then <- ggplot2::ggplot(age_past, ggplot2::aes(Cohort, Share, fill = Cohort)) +
    ggplot2::geom_col() +
    ggplot2::scale_y_continuous(labels = scales::percent_format(accuracy = 0.1), limits = c(0,1)) +
    ggplot2::labs(
      title = paste0("Age Distribution — ", unique(age_past$Year)),
      x = NULL, y = "Share of Population"
    ) + ggplot2::guides(fill = "none")

  p_age <- (p_age_then | p_age_now)
} else if (!is.null(age_now)) {
  p_age <- ggplot2::ggplot(age_now, ggplot2::aes(Cohort, Share, fill = Cohort)) +
    ggplot2::geom_col() +
    ggplot2::scale_y_continuous(labels = scales::percent_format(accuracy = 0.1), limits = c(0,1)) +
    ggplot2::labs(
      title = paste0("Age Distribution — ", unique(age_now$Year)),
      x = NULL, y = "Share of Population"
    ) + ggplot2::guides(fill = "none")
} else {
  p_age <- NULL
}

# ---------- 3) Median Household Income — MDR over time (last ~10 releases) ----------
years <- (yr-9):yr
income_ts <- dplyr::bind_rows(lapply(
  years,
  function(y) tidycensus::get_acs(
    geography = "place", state = "CA", survey = "acs5", year = y,
    variables = c(median = "B19013_001")
  ) |>
    dplyr::filter(NAME == place_name) |>
    dplyr::transmute(Year = y, Income = estimate)
)) |>
  dplyr::arrange(Year)

p_income_ts <- ggplot2::ggplot(income_ts, ggplot2::aes(Year, Income)) +
  ggplot2::geom_line() +
  ggplot2::geom_point(size = 2) +
  ggplot2::geom_smooth(method = "loess", se = FALSE, linetype = "dashed") +
  ggplot2::scale_x_continuous(breaks = years) +
  ggplot2::scale_y_continuous(labels = scales::dollar_format()) +
  ggplot2::labs(title = "Median Household Income — Marina del Rey (ACS 5-year, rolling releases)", x = NULL, y = "USD")

# ---------- 4) Housing stock — SFR vs Multifamily only (normalized) ----------
units_long <- tidycensus::get_acs(
  geography = "place", state = "CA", survey = "acs5", year = yr,
  variables = c(
    "B25024_001","B25024_002","B25024_003","B25024_004","B25024_005",
    "B25024_006","B25024_007","B25024_008","B25024_009","B25024_010"
  )
) |>
  dplyr::filter(NAME == place_name) |>
  dplyr::select(variable, estimate) |>
  dplyr::mutate(variable = dplyr::recode(variable,
    "B25024_001"="total", "B25024_002"="det", "B25024_003"="att",
    "B25024_004"="u2", "B25024_005"="u3_4", "B25024_006"="u5_9",
    "B25024_007"="u10_19", "B25024_008"="u20p", "B25024_009"="mobile",
    "B25024_010"="other"
  ))

units_wide <- tidyr::pivot_wider(units_long, names_from = variable, values_from = estimate, values_fill = 0)

sfr_units <- units_wide$det + units_wide$att
mf_units  <- units_wide$u2 + units_wide$u3_4 + units_wide$u5_9 + units_wide$u10_19 + units_wide$u20p
den_sel   <- sfr_units + mf_units

units_sel <- dplyr::tibble(
  Type = c("SFR","Multifamily"),
  Share = if (den_sel > 0) c(sfr_units/den_sel, mf_units/den_sel) else c(NA_real_, NA_real_)
)


# ---------- Print ----------

if (!is.null(p_age)) print(p_age)

yr <- 2023
place_name <- "Marina del Rey CDP, California"   # must match ACS naming

# --- 1) Resolve GEOID from ACS itself (using total population) ---
owner_age <- NULL
geo_try <- try(
  tidycensus::get_acs(
    geography = "place",
    state     = "CA",
    survey    = "acs5",
    year      = yr,
    variables = c(pop = "B01001_001"),       # total population
    cache_table = TRUE
  ),
  silent = TRUE
)

if (!inherits(geo_try, "try-error") && !is.null(geo_try) && nrow(geo_try)) {
  # Find exact, then fuzzy if needed
  geolist <- geo_try %>%
    mutate(NAME_clean = str_to_lower(NAME),
           target_clean = str_to_lower(place_name))
  georows <- geolist %>% filter(NAME_clean == target_clean)

  if (nrow(georows) == 0) {
    georows <- geolist %>% filter(str_detect(NAME_clean, regex("^marina\\s+del\\s+rey\\s+cdp\\b")))
  }
  if (nrow(georows) > 0) {
    geoid_mdr   <- georows$GEOID[1]
    place_label <- georows$NAME[1]

    # --- 2) Pull B25007 owner bins (male 002–009 + female 010–017) and sum by age ---
    age_levels   <- c("15–24","25–34","35–44","45–54","55–64","65–74","75–84","85+")
    owner_codes  <- c(2:9, 10:17)
    owner_lookup <- tibble::tibble(
      variable = paste0("B25007_", sprintf("%03d", owner_codes)),
      Age      = factor(rep(age_levels, times = 2), levels = age_levels)
    )

    b25007 <- try(
      tidycensus::get_acs(
        geography = "place",
        state     = "CA",
        survey    = "acs5",
        year      = yr,
        variables = owner_lookup$variable,
        cache_table = TRUE
      ),
      silent = TRUE
    )

    if (!inherits(b25007, "try-error") && !is.null(b25007) && nrow(b25007)) {
      owner_age <- b25007 %>%
        filter(GEOID == geoid_mdr) %>%
        select(variable, estimate) %>%
        inner_join(owner_lookup, by = "variable") %>%
        group_by(Age) %>%
        summarise(Households = sum(estimate, na.rm = TRUE), .groups = "drop") %>%
        mutate(Total = sum(Households, na.rm = TRUE),
               Share = if_else(Total > 0, Households / Total, NA_real_)) %>%
        select(Age, Households, Share)
    }
  }
}



```
Market Composition and Demographics

Age wise, the population of MDR has changed a lot in the last decade. It shifted from having a large retiree population in 2013, to a community of families, with the majority of residents in their 30s-40s, and a rising young population (signalling families).


```{r}
print(p_income_ts)
```

Income wise, MDR has been spiking ever since 2016. The median household income in MDR in 2023 was a little over $1.4m, compared to $87,000 in LA county. Overall, a high income population.


```{r}
print(p_tenure)
if (!is.null(owner_age) && nrow(owner_age) && any(!is.na(owner_age$Share))) {
  p_owner_age <- ggplot(owner_age, aes(x = Age, y = Share)) +
    geom_col() +
    scale_y_continuous(labels = percent_format(accuracy = 0.1), limits = c(0, 1)) +
    labs(
      title    = paste0("Owner-Occupied Households by Age of Householder — ", yr),
      subtitle = if (exists("place_label")) place_label else place_name,
      x = "Age of Householder",
      y = "Share of Owner-Occupied Households"
    )
  print(p_owner_age)
} else {
  message("Could not build the chart. Quick checks:\n",
          "1) Verify your Census API key: census_api_key('YOUR_KEY', install=TRUE); library(tidycensus)\n",
          "2) Confirm the place name matches ACS: 'Marina del Rey CDP, California'\n",
          "3) Try a nearby year (e.g., yr <- 2022 or 2021) in case of sparse data.")
}

```

The above graph shows the share of housing units that are rented vs owner-occupied. The vast majority of unit in MDR are rented, with a very small percentage being owner occupier. ]

The second graph shows the age of owner-occupiers specifically. The vast majority of them being between 35-44, and a large portion in retirement age. 




```{r permits_bar_from_files, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}
perm_dir <- "C:/Users/stange/Desktop/DTR/code/mdr/mdr/medians/permits"

# list all csvs
files <- list.files(perm_dir, pattern = "\\.csv$", full.names = TRUE)

parse_one <- function(path) {
  base <- tolower(basename(path))
  # asset from filename
  asset <- if (grepl("apartment", base)) "Apartment" else
           if (grepl("commercial", base)) "Commercial" else
           if (grepl("residential", base)) "Residential" else NA_character_
  # status from filename
  status <- if (grepl("final", base)) "Finaled" else
            if (grepl("issued", base)) "Issued" else NA_character_
  # count rows = permits
  n_rows <- tryCatch(nrow(suppressWarnings(readr::read_csv(path, show_col_types = FALSE))),
                     error = function(e) NA_integer_)
  data.frame(Asset = asset, Status = status, Permits = n_rows, stringsAsFactors = FALSE)
}

df <- do.call(rbind, lapply(files, parse_one))
df <- df[!is.na(df$Asset) & !is.na(df$Status) & !is.na(df$Permits), , drop = FALSE]

# aggregate & fill missing combos with zeros
bar_df <- df |>
  dplyr::group_by(Asset, Status) |>
  dplyr::summarise(Permits = sum(Permits, na.rm = TRUE), .groups = "drop") |>
  tidyr::complete(
    Asset  = c("Apartment","Commercial","Residential"),
    Status = c("Issued","Finaled"),
    fill = list(Permits = 0)
  ) |>
  dplyr::mutate(
    Asset  = factor(Asset,  levels = c("Apartment","Commercial","Residential")),
    Status = factor(Status, levels = c("Issued","Finaled"))
  )

p <- ggplot2::ggplot(bar_df, ggplot2::aes(x = Asset, y = Permits, fill = Status)) +
  ggplot2::geom_col(position = ggplot2::position_dodge(width = 0.7), width = 0.6) +
  ggplot2::geom_text(ggplot2::aes(label = Permits),
                     position = ggplot2::position_dodge(width = 0.7),
                     vjust = -0.3, size = 3) +
  ggplot2::scale_y_continuous(expand = ggplot2::expansion(mult = c(0, 0.08))) +
  ggplot2::labs(
    title = "Permits by Asset Type and Status",
    x = NULL, y = "Number of Permits", fill = NULL
  )

print(p)



# Build two bar charts from the raw CSV files (no date dependency):
# 1) Issued only: x = Asset (Apartment/Commercial/Residential), color = Action (New/Demolition)
# 2) Finaled only: same as above

perm_dir <- "C:/Users/stange/Desktop/DTR/code/mdr/mdr/medians/permits"
files <- list.files(perm_dir, pattern = "\\.csv$", full.names = TRUE)

parse_one <- function(path) {
  base <- tolower(basename(path))
  asset <- if (grepl("apartment",  base)) "Apartment"  else
           if (grepl("commercial", base)) "Commercial" else
           if (grepl("residential",base)) "Residential" else NA_character_
  action <- if (grepl("demo", base)) "Demolition" else
            if (grepl("new",  base)) "New"        else NA_character_
  status <- if (grepl("final",  base)) "Finaled" else
            if (grepl("issued", base)) "Issued"  else NA_character_
  n_rows <- tryCatch(nrow(suppressWarnings(readr::read_csv(path, show_col_types = FALSE))),
                     error = function(e) NA_integer_)
  data.frame(Asset = asset, Action = action, Status = status, Permits = n_rows, stringsAsFactors = FALSE)
}

df <- do.call(rbind, lapply(files, parse_one))
df <- df[!is.na(df$Asset) & !is.na(df$Action) & !is.na(df$Status) & !is.na(df$Permits), , drop = FALSE]

# Aggregate counts and fill missing combos with zeros
base_levels_asset  <- c("Apartment","Commercial","Residential")
base_levels_action <- c("New","Demolition")

agg <- df |>
  dplyr::group_by(Asset, Action, Status) |>
  dplyr::summarise(Permits = sum(Permits, na.rm = TRUE), .groups = "drop")

# ----- Chart 1: Issued only -----
issued_df <- agg |>
  dplyr::filter(Status == "Issued") |>
  tidyr::complete(
    Asset  = base_levels_asset,
    Action = base_levels_action,
    fill = list(Permits = 0)
  ) |>
  dplyr::mutate(
    Asset  = factor(Asset,  levels = base_levels_asset),
    Action = factor(Action, levels = base_levels_action)
  )

p_issued <- ggplot2::ggplot(issued_df, ggplot2::aes(x = Asset, y = Permits, fill = Action)) +
  ggplot2::geom_col(position = ggplot2::position_dodge(width = 0.7), width = 0.6) +
  ggplot2::geom_text(ggplot2::aes(label = Permits),
                     position = ggplot2::position_dodge(width = 0.7),
                     vjust = -0.3, size = 3) +
  ggplot2::scale_y_continuous(expand = ggplot2::expansion(mult = c(0, 0.08))) +
  ggplot2::labs(
    title = "Permits (Issued) — by Asset and Action",
    x = NULL, y = "Number of Permits", fill = NULL
  )

print(p_issued)

# ----- Chart 2: Finaled only -----
finaled_df <- agg |>
  dplyr::filter(Status == "Finaled") |>
  tidyr::complete(
    Asset  = base_levels_asset,
    Action = base_levels_action,
    fill = list(Permits = 0)
  ) |>
  dplyr::mutate(
    Asset  = factor(Asset,  levels = base_levels_asset),
    Action = factor(Action, levels = base_levels_action)
  )

p_finaled <- ggplot2::ggplot(finaled_df, ggplot2::aes(x = Asset, y = Permits, fill = Action)) +
  ggplot2::geom_col(position = ggplot2::position_dodge(width = 0.7), width = 0.6) +
  ggplot2::geom_text(ggplot2::aes(label = Permits),
                     position = ggplot2::position_dodge(width = 0.7),
                     vjust = -0.3, size = 3) +
  ggplot2::scale_y_continuous(expand = ggplot2::expansion(mult = c(0, 0.08))) +
  ggplot2::labs(
    title = "Permits (Finaled) — by Asset and Action",
    x = NULL, y = "Number of Permits", fill = NULL
  )

print(p_finaled)
```

The above 3 graphs show show permit data from the last year. We can see most permits we residential, and many were finaled. Very interestingly, a lot of demolition permits were  finaled, and a lot of new construction permits were issued, all around the same time and with similar numbers. This indicates a strong developer confidence in the market. 


```{r}
sales_data <- read.csv(
  "C:/Users/stange/Desktop/DTR/code/mdr/mdr/individual/june23-25.csv",
  stringsAsFactors = FALSE
)

top_buildings <- sales_data %>%
  mutate(
    # Normalize: lowercase, trim, collapse spaces
    Address_clean = str_squish(str_to_lower(Address)),
    # Remove "#" and everything after it
    BaseAddress = str_trim(str_remove(Address_clean, "\\s+#.*$"))
  ) %>%
  group_by(BaseAddress) %>%
  summarise(SalesCount = n(), .groups = "drop") %>%
  arrange(desc(SalesCount)) %>%
  slice_head(n = 25)

print(top_buildings)


leases <- read_csv(
  "C:/Users/stange/Desktop/DTR/code/mdr/mdr/individual/lease-24-25.csv",
  show_col_types = FALSE
)

# Helper: normalize address and strip unit/suite identifiers at the end
norm_addr <- function(x) {
  x %>%
    str_to_lower() %>%                         # case-insensitive
    str_replace_all(",", " ") %>%              # remove commas
    str_squish() %>%                           # collapse extra spaces
    # remove things like "#123", "apt 3b", "unit a", "suite 4", "ste c", "space 12", "no 5" at the END
    str_replace("\\s+(?:#|unit|apt|apartment|suite|ste|space|spc|no\\.?|number)\\s*[-\\w]+\\s*$", "") %>%
    str_squish()
}

leases_clean <- leases %>%
  mutate(
    Address_clean = norm_addr(Address),
    City_clean    = str_squish(str_to_lower(City))
  )

top_buildings_lease <- leases_clean %>%
  group_by(City_clean, Address_clean) %>%
  summarise(LeaseCount = n(), .groups = "drop") %>%
  arrange(desc(LeaseCount)) %>%
  slice_head(n = 25)

print(top_buildings_lease)
```

The above two tables show the top 15 addresses (without unit number) for sales and leases. These range from large to midsize buildings.


```{r}


pick_file <- function(candidates) {
  f <- candidates[file.exists(candidates)]
  if (length(f) == 0) stop("None of these files found: ", paste(candidates, collapse = ", "))
  f[1]
}

read_top10 <- function(path) {
  read_csv(
    pick_file(path),
    show_col_types = FALSE,
    col_types = cols(name = col_character(), count = col_integer())
  ) |>
    filter(!is.na(name), name != "") |>
    group_by(name) |>
    summarise(count = sum(count, na.rm = TRUE), .groups = "drop") |>
    slice_max(order_by = count, n = 15, with_ties = FALSE)
}

seller_agent_top10     <- read_top10(c("seller_agent_counts.csv",     "Seller_agent_counts__preview_.csv"))
buyer_agent_top10      <- read_top10(c("buyer_agent_counts.csv",      "Buyer_agent_counts__preview_.csv"))
seller_brokerage_top10 <- read_top10(c("seller_brokerage_counts.csv", "Seller_brokerage_counts__preview_.csv"))
buyer_brokerage_top10  <- read_top10(c("buyer_brokerage_counts.csv",  "Buyer_brokerage_counts__preview_.csv"))

cat("### Top 10 Seller Agents\n")
print(as.data.frame(seller_agent_top10), row.names = FALSE)



cat("\n### Top 10 Seller Brokerages\n")
print(as.data.frame(seller_brokerage_top10), row.names = FALSE)











```
Leading Agents:

The above two tables show the leading seller's agents and brokerages. 

While Jesse Weinberg has a strong presence, the market is definitely diversified and competitive. Interestingly, While the agent Jesse Weinberg has lot of sales, Compass is the leader as a firm.

```{r}
cat("\n### Top 10 Buyer Agents\n")
print(as.data.frame(buyer_agent_top10), row.names = FALSE)

cat("\n### Top 10 Buyer Brokerages\n")
print(as.data.frame(buyer_brokerage_top10), row.names = FALSE)
```



The above tables show the top buyer's agents and brokerages. Overall, we see a similar picture to the seller overview, with some variations. 



Large Projects:

Upcoming:

1. Mercy Housing — 4206 Admiralty Way

Plans approved for Marina del Rey’s first 100% affordable housing development: a seven-story building with 120 apartments, 2,250 sq ft retail, and a 9,000 sq ft community garden.


3. Paseo Marina Mixed-Use Project

A major mixed-use plan in City territory (adjacent to MDR) is under environmental review:

Option A: ~658 residential units + 27,300 sq ft retail/restaurant.

Option B: ~425 units + 90,000 sq ft office + 40,000 sq ft commercial + 1-acre public space.



Completed Projects

Several notable developments have finished in recent years:

Wayfarer Apartments (Parcel 28) – Completed November 2019

Neptune Marina Apartments (Parcels 10/14) – Completed June 2020

Boardwalk Marina del Rey / Pier 44 – Completed December 2020

Marriott Hotel (Residence Inn + Courtyard) (Parcel 9U) – Completed August 2021

Venice Dual Force Main sewer project – Completed December 2020




Conclusions:

While the last 2 years the MDR market for condos and SFRs saw a slowdown, it seems to be picking up slowly. Condos with 2 bedrooms and more are in high demand and prices reflect that. 

The market for both Condos and SFRs, as is much of LA, is currently a buyer's market, and properties are taking longer to sell. In addition, the overall volume has been lower that 2021. Another supporting evidence for the buyer's market hypothesis is the high new/clsoed, ratio, indicating more properties are listed than sold.

Most condos are concentrated around the marina, and range widely in prices. MDR is practially split in two by Lincoln Blvd, with hot areas being around the marina, and between Washington blvd, Culver Blvd, and Lincoln Blvd. West of Lincoln is dominated by condos, whereas east of Lincoln has a lot more houses. 

The rental market in MDR has been fairly steady, with lease prices of houses rising a bit faster than condo lease prices. Vacancy has spiked in the last 5 years, but is decreasing now. The vast majority of MDR residents are renters. 

The population of MDR is often thought of as older, but in reality it is getting younger, and more family oriented, with the vast majority of owner-occupier being between the ages of 35-44. However, a large portion of owner occupiers are between 55-85. The average resident of MDR earns almost double the average resident in LA county.


The last few years saw a spike in demolition permits finalized, and new construction permits issued. This is a strong indication that developers are interested and confident in the MDR real estate market. 


The condo sale market is dominated by a few buildings, and while the lease market is similar, it is more diversified. 


Competition wise, the market has strong players but they are not dominating. There is quite a diverse array of agents buyer and selling. 


Proposed Strategy: Our sellers should be older people, ready to downsize or move out, and our buyers are family age parents, with a high income, between the ages of 35-44. We might want to choose specific large buildings and advertise repeatedly there, and find smaller buildings with less movement and contact the manager, board members of HOAs, or anyone else that we could offer referral fees to enter the market.
